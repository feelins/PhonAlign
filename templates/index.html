<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极地语音数据处理服务</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 确保已正确引入Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 添加 Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <!-- 或者使用 PNG 格式 -->
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">语音数据处理服务</h1>
        <!-- 添加导航选项卡 -->
        <ul class="nav nav-tabs mb-1" id="serviceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="alignment-tab" data-bs-toggle="tab" data-bs-target="#alignment" type="button" role="tab">
                    <i class="bi-calendar me-2"></i>音频对齐
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button" role="tab">
                    <i class="bi bi-collection me-2"></i>批量对齐
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="duration-tab" data-bs-toggle="tab" data-bs-target="#duration" type="button" role="tab">
                    <i class="bi me-1"></i>计算时长
                </button>
            </li>
        </ul>
        <!-- 选项卡内容 -->
        <div class="tab-content" id="serviceTabsContent">
            <!-- 文本对齐选项卡 (原有内容) -->
            <div class="tab-pane fade show active" id="alignment" role="tabpanel">
                <div class="card">
                    <div class="card-header">上传文件</div>
                    <div class="card-body">
                        <form id="alignmentForm">
                            <div class="form-group">
                                <label for="audio_file" class="form-label">音频文件 (WAV/MP3)</label>
                                <input class="form-control" type="file" id="audio_file" name="audio_file" accept=".wav,.mp3" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="text_content" class="form-label">文本内容</label>
                                <textarea class="form-control" id="text_content" name="text_content" rows="3" required placeholder="请输入要与音频对齐的文本">一抹脸上，小友发现全是鲜血</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="output_name" class="form-label">输出文件名</label>
                                <input type="text" class="form-control" id="output_name" name="output_name" value="output" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" id="loadingSpinner" style="display: none;" role="status" aria-hidden="true"></span>
                                开始对齐
                            </button>
                            
                            <div class="progress mt-3" id="progressBar" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                        </form>
                    </div>
                </div>
        
                <div id="resultSection" style="display: none;">
                    <div class="card mt-4">
                        <div class="card-header">处理结果</div>
                        <div class="card-body">
                            <div id="statusMessage" class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 处理正在进行中，请稍候...
                            </div>
                            
                            <div class="d-flex gap-2">
                                <a id="downloadTextgridBtn" class="btn btn-success btn-download" style="display: none;">
                                    <i class="bi bi-download"></i> 下载TextGrid文件
                                </a>
                                <a id="downloadAudioBtn" class="btn btn-outline-primary btn-download" style="display: none;">
                                    <i class="bi bi-download"></i> 下载音频文件
                                </a>
                            </div>
                        </div>
                    </div>
        
                    <div class="visualization-container">
                        <div class="card">
                            <div class="card-header">可视化结果</div>
                            <div class="visualization-card">
                                <div class="visualization-title">音频频谱图</div>
                                <img id="spectrogram-img" src="" alt="频谱图">
                            </div>
                            <div class="visualization-card">
                                <div class="visualization-title">TextGrid对齐结果</div>
                                <img id="textgrid-img" src="" alt="TextGrid可视化">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新增批量音频对齐选项卡 -->
            <div class="tab-pane fade" id="batch" role="tabpanel">
                <div class="card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-collection-play me-2"></i>批量音频文本对齐
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="batchForm" class="needs-validation" novalidate>
                            <div class="mb-4">
                                <label class="form-label fw-bold">上传方式</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadType" id="uploadZip" value="zip" checked>
                                    <label class="form-check-label" for="uploadZip">
                                        上传ZIP压缩包（包含音频和文本文件）
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="uploadType" id="uploadDir" value="dir">
                                    <label class="form-check-label" for="uploadDir">
                                        选择包含音频和文本文件的目录
                                    </label>
                                </div>
                            </div>
                            
                            <!-- ZIP上传部分 -->
                            <div id="zipUploadSection">
                                <div class="mb-3">
                                    <label for="batchZipFile" class="form-label fw-bold">上传ZIP文件</label>
                                    <input class="form-control" type="file" id="batchZipFile" name="batch_zip" accept=".zip">
                                    <div class="form-text">
                                        ZIP文件应包含音频文件（.wav/.mp3）和同名文本文件（.txt），例如：audio1.wav 和 audio1.txt
                                    </div>
                                </div>
                            </div>

                            <!-- 分别上传部分修改为目录 -->
                            <div id="dirUploadSection" style="display: none;">
                                <div class="mb-3">
                                    <label for="batchDirPath" class="form-label fw-bold">选择目录</label>
                                    <input class="form-control" type="file" id="batchDirPath" name="batch_dir" webkitdirectory directory multiple>
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        音频文件和文本文件必须同名（扩展名不同），例如：audio1.wav 和 audio1.txt
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="outputPrefix" class="form-label fw-bold">输出文件名前缀</label>
                                <input type="text" class="form-control" id="outputPrefix" name="output_prefix" value="batch_output">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-info text-white" id="batchSubmitBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="batchSpinner"></span>
                                    <i class="bi bi-gear-wide-connected me-2"></i>开始批量处理
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-4 d-none" id="batchProgressSection">
                            <div class="d-flex justify-content-between mb-2">
                                <h5>处理进度</h5>
                                <span id="batchProgressText">0/0</span>
                            </div>
                            <div class="progress batch-progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="batchProgressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">处理结果</h5>
                                </div>
                                <div class="card-body batch-results-container" id="batchResults">
                                    <!-- 结果将在这里动态生成 -->
                                </div>
                            </div>
                            
                            <div class="mt-3 d-none" id="batchDownloadSection">
                                <button class="btn btn-success" id="downloadAllBtn">
                                    <i class="bi bi-download me-2"></i>下载全部结果 (ZIP)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 计算时长选项卡 (新增内容) -->
            <div class="tab-pane fade" id="duration" role="tabpanel">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi-code-square me-2"></i>音频目录时长计算
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="durationForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="directoryPath" class="form-label fw-bold">音频目录路径</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi-folder"></i>
                                    </span>
                                    <input type="text" class="form-control" id="directoryPath" 
                                           name="directory_path" placeholder="例如: /path/to/audio_files" required>
                                </div>
                                <div class="form-text text-muted">
                                    支持格式: WAV, MP3 (将递归扫描子目录)
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="calculateBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="durationSpinner"></span>
                                    <i class="bi bi-calculator me-2"></i>计算总时长
                                </button>
                            </div>
                        </form>
                        
                        <div id="durationResult" class="mt-4 d-none">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="bi-info-circle me-2"></i>计算结果</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong>总时长:</strong></p>
                                            <h3 id="totalDuration" class="text-success">0.00</h3>
                                            <p>秒</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong>约合:</strong></p>
                                            <h3 id="totalHours" class="text-success">0.00</h3>
                                            <p>小时</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="mb-1"><strong>处理的文件数:</strong> <span id="fileCount" class="badge bg-primary">0</span></p>
                                    <p class="mb-1"><strong>目录路径:</strong> <span id="dirPath" class="text-muted"></span></p>
                                </div>
                            </div>
                            
                            <div id="durationErrorSection" class="mt-3 d-none">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>错误文件</h5>
                                    </div>
                                    <ul id="durationErrorList" class="list-group list-group-flush"></ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="durationErrorAlert" class="alert alert-danger mt-4 d-none">
                            <i class="bi bi-exclamation-octagon me-2"></i>
                            <span id="durationErrorMessage"></span>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <div class="d-flex justify-content-between">
                            <span>音频处理系统</span>
                            <span id="durationProcessTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!--container-->

    
    <footer class="mt-5 pt-4 pb-2 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 mb-3">
                    <h5>极地智创</h5>
                    <ul class="list-unstyled">
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">关于我们</a></li>
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">加入我们</a></li>
                        <li><a href="#" class="text-decoration-none text-muted">联系我们</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 mb-3">
                    <h5>产品服务</h5>
                    <ul class="list-unstyled">
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">语音对齐</a></li>
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">批量处理</a></li>
                        <li><a href="#" class="text-decoration-none text-muted">API接口</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 mb-3">
                    <h5>帮助支持</h5>
                    <ul class="list-unstyled">
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">文档中心</a></li>
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">常见问题</a></li>
                        <li><a href="#" class="text-decoration-none text-muted">提交反馈</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 mb-3">
                    <h5>法律信息</h5>
                    <ul class="list-unstyled">
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">隐私政策</a></li>
                        <li class="mb-1"><a href="#" class="text-decoration-none text-muted">服务条款</a></li>
                        <li><a href="#" class="text-decoration-none text-muted">版权声明</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-top pt-3 mt-3 text-center text-muted">
                <small>© 2025 极地智创信息科技 | 版本 v1.0 | </small>
            </div>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('alignmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.querySelector('#alignmentForm button[type="submit"]');
            const spinner = document.getElementById('loadingSpinner');
            const progressBar = document.getElementById('progressBar');
            const resultSection = document.getElementById('resultSection');
            const statusMessage = document.getElementById('statusMessage');
            
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            progressBar.style.display = 'block';
            resultSection.style.display = 'block';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('audio_file', document.getElementById('audio_file').files[0]);
            formData.append('text_content', document.getElementById('text_content').value);
            formData.append('output_name', document.getElementById('output_name').value);
            
            // Send request
            fetch('/', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || '服务器返回错误状态');
                    }).catch(() => {
                        throw new Error(`HTTP错误: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.status !== 'success') {
                    throw new Error('处理未成功完成');
                }
                
                // Update status message
                statusMessage.className = 'alert alert-success';
                statusMessage.innerHTML = `<i class="bi bi-check-circle"></i> 对齐处理成功完成！耗时 <span class="processing-time">${data.processing_time}秒</span>`;
                
                // Set download links
                const downloadTextgridBtn = document.getElementById('downloadTextgridBtn');
                const downloadAudioBtn = document.getElementById('downloadAudioBtn');
                
                downloadTextgridBtn.href = `/download/${data.unique_id}/${data.textgrid_file}`;
                downloadTextgridBtn.style.display = 'inline-block';
                
                downloadAudioBtn.href = `/download/${data.unique_id}/${data.audio_file}`;
                downloadAudioBtn.style.display = 'inline-block';
                
                // Display visualizations
                document.getElementById('spectrogram-img').src = `/download/${data.unique_id}/${data.spectrogram}`;
                document.getElementById('textgrid-img').src = `/download/${data.unique_id}/${data.textgrid_viz}`;
            })
            .catch(error => {
                console.error('Error:', error);
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<i class="bi bi-exclamation-triangle"></i> 处理失败: ${error.message}`;
            })
            .finally(() => {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                progressBar.style.display = 'none';
            });
        });

        // 新增计算时长表单的JavaScript
        document.getElementById('durationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const calculateBtn = document.getElementById('calculateBtn');
            const spinner = document.getElementById('durationSpinner');
            const resultDiv = document.getElementById('durationResult');
            const errorAlert = document.getElementById('durationErrorAlert');
            const errorMessage = document.getElementById('durationErrorMessage');
            
            // 重置UI
            resultDiv.classList.add('d-none');
            errorAlert.classList.add('d-none');
            calculateBtn.disabled = true;
            spinner.classList.remove('d-none');
            
            const formData = new FormData(e.target);
            
            try {
                const startTime = new Date();
                const response = await fetch('/calculate_duration/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const endTime = new Date();
                const processTime = (endTime - startTime) / 1000;
                
                document.getElementById('durationProcessTime').textContent = `处理时间: ${processTime.toFixed(2)}秒`;
                
                if (data.status === 'success') {
                    document.getElementById('totalDuration').textContent = 
                        data.total_duration_seconds.toFixed(2);
                    document.getElementById('totalHours').textContent = 
                        data.total_duration_hours.toFixed(2);
                    document.getElementById('fileCount').textContent = data.file_count;
                    document.getElementById('dirPath').textContent = data.directory_path;
                    
                    // 显示错误文件（如果有）
                    if (data.error_files && data.error_files.length > 0) {
                        const errorSection = document.getElementById('durationErrorSection');
                        const errorList = document.getElementById('durationErrorList');
                        
                        errorList.innerHTML = '';
                        data.error_files.forEach(file => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-start';
                            li.innerHTML = `
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">${file.filename}</div>
                                    ${file.error}
                                </div>
                                <span class="badge bg-danger rounded-pill">!</span>
                            `;
                            errorList.appendChild(li);
                        });
                        
                        errorSection.classList.remove('d-none');
                    } else {
                        document.getElementById('durationErrorSection').classList.add('d-none');
                    }
                    
                    resultDiv.classList.remove('d-none');
                } else {
                    errorMessage.textContent = data.message;
                    errorAlert.classList.remove('d-none');
                }
            } catch (err) {
                errorMessage.textContent = `请求失败: ${err.message}`;
                errorAlert.classList.remove('d-none');
            } finally {
                calculateBtn.disabled = false;
                spinner.classList.add('d-none');
            }
        });

        // 新增批量处理相关JavaScript
        document.addEventListener('DOMContentLoaded', function() {

            // 修改上传方式切换逻辑
            document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const zipSection = document.getElementById('zipUploadSection');
                    const dirSection = document.getElementById('dirUploadSection');
                    
                    if (this.value === 'zip') {
                        zipSection.style.display = 'block';
                        dirSection.style.display = 'none';
                    } else {
                        zipSection.style.display = 'none';
                        dirSection.style.display = 'block';
                    }
                });
            });
            
            // 批量处理表单提交
            document.getElementById('batchForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('batchSubmitBtn');
                const spinner = document.getElementById('batchSpinner');
                const progressSection = document.getElementById('batchProgressSection');
                const progressBar = document.getElementById('batchProgressBar');
                const progressText = document.getElementById('batchProgressText');
                const batchResults = document.getElementById('batchResults');
                const downloadSection = document.getElementById('batchDownloadSection');
                
                // 重置UI
                submitBtn.disabled = true;
                spinner.classList.remove('d-none');
                batchResults.innerHTML = '';
                progressBar.style.width = '0%';
                progressText.textContent = '0/0';
                downloadSection.classList.add('d-none');
                
                // 准备表单数据
                const formData = new FormData(this);
                const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
                formData.delete('batch_dir'); // 清除之前的字段

                // 根据上传类型处理不同输入
                if (uploadType === 'zip') {
                    const zipFile = document.getElementById('batchZipFile').files[0];
                    if (!zipFile) {
                        alert('请选择ZIP文件');
                        submitBtn.disabled = false;
                        spinner.classList.add('d-none');
                        return;
                    }
                    formData.append('batch_zip', zipFile);
                }

                if (uploadType === 'dir') {
                    const dirInput = document.getElementById('batchDirPath');
                    
                    if (dirInput.files.length === 0) {
                        alert('请选择目录');
                        submitBtn.disabled = false;
                        spinner.classList.add('d-none');
                        return;
                    }
                    console.log(dirInput.files);
                    // 添加目录中的所有文件到FormData
                    for (let i = 0; i < dirInput.files.length; i++) {
                        formData.append('batch_files', dirInput.files[i]);
                    }
                }
                
                try {
                    const response = await fetch('/batch_align/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // 显示进度区域
                    progressSection.classList.remove('d-none');
                    
                    // 开始轮询处理状态
                    const jobId = data.job_id;
                    await pollBatchStatus(jobId, progressBar, progressText, batchResults, downloadSection);
                    
                } catch (error) {
                    console.error('批量处理错误:', error);
                    batchResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            批量处理失败: ${error.message}
                        </div>
                    `;
                    progressSection.classList.remove('d-none');
                } finally {
                    submitBtn.disabled = false;
                    spinner.classList.add('d-none');
                }
            });
        });
        
        // 轮询批量处理状态
        async function pollBatchStatus(jobId, progressBar, progressText, batchResults, downloadSection) {
            let completed = false;
            let retryCount = 0;
            const maxRetries = 10;
            
            while (!completed && retryCount < maxRetries) {
                try {
                    const response = await fetch(`/batch_status/${jobId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        // 处理完成
                        completed = true;
                        updateProgressUI(data, progressBar, progressText, batchResults);
                        
                        // 显示下载按钮
                        if (data.result_zip) {
                            const downloadBtn = document.getElementById('downloadAllBtn');
                            downloadBtn.onclick = () => {
                                window.location.href = `/download_batch/${jobId}/${data.result_zip}`;
                            };
                            downloadSection.classList.remove('d-none');
                        }
                        
                        // 添加成功消息
                        batchResults.innerHTML += `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                批量处理完成！共处理 ${data.total} 个文件，成功 ${data.success_count} 个，失败 ${data.error_count} 个。
                            </div>
                        `;
                    } else if (data.status === 'processing') {
                        // 更新进度
                        updateProgressUI(data, progressBar, progressText, batchResults);
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2秒后再次检查
                    } else if (data.status === 'failed') {
                        // 处理失败
                        completed = true;
                        batchResults.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                批量处理失败: ${data.message || '未知错误'}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('轮询错误:', error);
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        batchResults.innerHTML += `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                获取处理状态失败: ${error.message}
                            </div>
                        `;
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 错误后等待2秒重试
                }
            }
        }
        
        // 更新进度UI
        function updateProgressUI(data, progressBar, progressText, batchResults) {
            const progress = Math.round((data.processed / data.total) * 100);
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${data.processed}/${data.total}`;
            
            // 更新结果列表
            if (data.latest_results && data.latest_results.length > 0) {
                data.latest_results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `batch-result-item ${result.status === 'error' ? 'error' : ''}`;
                    resultDiv.innerHTML = `
                        <div class="p-3">
                            <h6 class="mb-1">
                                ${result.filename}
                                <span class="badge ${result.status === 'success' ? 'bg-success' : 'bg-danger'} float-end">
                                    ${result.status === 'success' ? '成功' : '失败'}
                                </span>
                            </h6>
                            <small class="text-muted">${result.message || ''}</small>
                            ${result.download_link ? `
                            <div class="mt-2">
                                <a href="${result.download_link}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download me-1"></i>下载
                                </a>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    batchResults.appendChild(resultDiv);
                });
            }
        }
    </script>
</body>
</html>