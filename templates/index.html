<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频文本对齐服务</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 确保已正确引入Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 添加 Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <!-- 或者使用 PNG 格式 -->
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">音频文本对齐服务</h1>
        <!-- 添加导航选项卡 -->
        <ul class="nav nav-tabs mb-4" id="serviceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="alignment-tab" data-bs-toggle="tab" data-bs-target="#alignment" type="button" role="tab">
                    <i class="bi-calendar me-2"></i>文本对齐
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="duration-tab" data-bs-toggle="tab" data-bs-target="#duration" type="button" role="tab">
                    <i class="bi me-1"></i>计算时长
                </button>
            </li>
        </ul>
        <!-- 选项卡内容 -->
        <div class="tab-content" id="serviceTabsContent">
            <!-- 文本对齐选项卡 (原有内容) -->
            <div class="tab-pane fade show active" id="alignment" role="tabpanel">
                <div class="card">
                    <div class="card-header">上传文件</div>
                    <div class="card-body">
                        <form id="alignmentForm">
                            <div class="form-group">
                                <label for="audio_file" class="form-label">音频文件 (WAV/MP3)</label>
                                <input class="form-control" type="file" id="audio_file" name="audio_file" accept=".wav,.mp3" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="text_content" class="form-label">文本内容</label>
                                <textarea class="form-control" id="text_content" name="text_content" rows="3" required placeholder="请输入要与音频对齐的文本">一抹脸上，小友发现全是鲜血</textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="output_name" class="form-label">输出文件名</label>
                                <input type="text" class="form-control" id="output_name" name="output_name" value="output" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" id="loadingSpinner" style="display: none;" role="status" aria-hidden="true"></span>
                                开始对齐
                            </button>
                            
                            <div class="progress mt-3" id="progressBar" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                        </form>
                    </div>
                </div>
        
                <div id="resultSection" style="display: none;">
                    <div class="card mt-4">
                        <div class="card-header">处理结果</div>
                        <div class="card-body">
                            <div id="statusMessage" class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 处理正在进行中，请稍候...
                            </div>
                            
                            <div class="d-flex gap-2">
                                <a id="downloadTextgridBtn" class="btn btn-success btn-download" style="display: none;">
                                    <i class="bi bi-download"></i> 下载TextGrid文件
                                </a>
                                <a id="downloadAudioBtn" class="btn btn-outline-primary btn-download" style="display: none;">
                                    <i class="bi bi-download"></i> 下载音频文件
                                </a>
                            </div>
                        </div>
                    </div>
        
                    <div class="visualization-container">
                        <div class="card">
                            <div class="card-header">可视化结果</div>
                            <div class="visualization-card">
                                <div class="visualization-title">音频频谱图</div>
                                <img id="spectrogram-img" src="" alt="频谱图">
                            </div>
                            <div class="visualization-card">
                                <div class="visualization-title">TextGrid对齐结果</div>
                                <img id="textgrid-img" src="" alt="TextGrid可视化">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 计算时长选项卡 (新增内容) -->
            <div class="tab-pane fade" id="duration" role="tabpanel">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi-code-square me-2"></i>音频目录时长计算
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="durationForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="directoryPath" class="form-label fw-bold">音频目录路径</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi-folder"></i>
                                    </span>
                                    <input type="text" class="form-control" id="directoryPath" 
                                           name="directory_path" placeholder="例如: /path/to/audio_files" required>
                                </div>
                                <div class="form-text text-muted">
                                    支持格式: WAV, MP3 (将递归扫描子目录)
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary" id="calculateBtn">
                                    <span class="spinner-border spinner-border-sm d-none" id="durationSpinner"></span>
                                    <i class="bi bi-calculator me-2"></i>计算总时长
                                </button>
                            </div>
                        </form>
                        
                        <div id="durationResult" class="mt-4 d-none">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="bi-info-circle me-2"></i>计算结果</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong>总时长:</strong></p>
                                            <h3 id="totalDuration" class="text-success">0.00</h3>
                                            <p>秒</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong>约合:</strong></p>
                                            <h3 id="totalHours" class="text-success">0.00</h3>
                                            <p>小时</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="mb-1"><strong>处理的文件数:</strong> <span id="fileCount" class="badge bg-primary">0</span></p>
                                    <p class="mb-1"><strong>目录路径:</strong> <span id="dirPath" class="text-muted"></span></p>
                                </div>
                            </div>
                            
                            <div id="durationErrorSection" class="mt-3 d-none">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>错误文件</h5>
                                    </div>
                                    <ul id="durationErrorList" class="list-group list-group-flush"></ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="durationErrorAlert" class="alert alert-danger mt-4 d-none">
                            <i class="bi bi-exclamation-octagon me-2"></i>
                            <span id="durationErrorMessage"></span>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <div class="d-flex justify-content-between">
                            <span>音频处理系统</span>
                            <span id="durationProcessTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!--container-->
        
        
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('alignmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.querySelector('#alignmentForm button[type="submit"]');
            const spinner = document.getElementById('loadingSpinner');
            const progressBar = document.getElementById('progressBar');
            const resultSection = document.getElementById('resultSection');
            const statusMessage = document.getElementById('statusMessage');
            
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            progressBar.style.display = 'block';
            resultSection.style.display = 'block';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('audio_file', document.getElementById('audio_file').files[0]);
            formData.append('text_content', document.getElementById('text_content').value);
            formData.append('output_name', document.getElementById('output_name').value);
            
            // Send request
            fetch('/', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || '服务器返回错误状态');
                    }).catch(() => {
                        throw new Error(`HTTP错误: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.status !== 'success') {
                    throw new Error('处理未成功完成');
                }
                
                // Update status message
                statusMessage.className = 'alert alert-success';
                statusMessage.innerHTML = `<i class="bi bi-check-circle"></i> 对齐处理成功完成！耗时 <span class="processing-time">${data.processing_time}秒</span>`;
                
                // Set download links
                const downloadTextgridBtn = document.getElementById('downloadTextgridBtn');
                const downloadAudioBtn = document.getElementById('downloadAudioBtn');
                
                downloadTextgridBtn.href = `/download/${data.unique_id}/${data.textgrid_file}`;
                downloadTextgridBtn.style.display = 'inline-block';
                
                downloadAudioBtn.href = `/download/${data.unique_id}/${data.audio_file}`;
                downloadAudioBtn.style.display = 'inline-block';
                
                // Display visualizations
                document.getElementById('spectrogram-img').src = `/download/${data.unique_id}/${data.spectrogram}`;
                document.getElementById('textgrid-img').src = `/download/${data.unique_id}/${data.textgrid_viz}`;
            })
            .catch(error => {
                console.error('Error:', error);
                statusMessage.className = 'alert alert-danger';
                statusMessage.innerHTML = `<i class="bi bi-exclamation-triangle"></i> 处理失败: ${error.message}`;
            })
            .finally(() => {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                progressBar.style.display = 'none';
            });
        });

        // 新增计算时长表单的JavaScript
        document.getElementById('durationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const calculateBtn = document.getElementById('calculateBtn');
            const spinner = document.getElementById('durationSpinner');
            const resultDiv = document.getElementById('durationResult');
            const errorAlert = document.getElementById('durationErrorAlert');
            const errorMessage = document.getElementById('durationErrorMessage');
            
            // 重置UI
            resultDiv.classList.add('d-none');
            errorAlert.classList.add('d-none');
            calculateBtn.disabled = true;
            spinner.classList.remove('d-none');
            
            const formData = new FormData(e.target);
            
            try {
                const startTime = new Date();
                const response = await fetch('/calculate_duration/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const endTime = new Date();
                const processTime = (endTime - startTime) / 1000;
                
                document.getElementById('durationProcessTime').textContent = `处理时间: ${processTime.toFixed(2)}秒`;
                
                if (data.status === 'success') {
                    document.getElementById('totalDuration').textContent = 
                        data.total_duration_seconds.toFixed(2);
                    document.getElementById('totalHours').textContent = 
                        data.total_duration_hours.toFixed(2);
                    document.getElementById('fileCount').textContent = data.file_count;
                    document.getElementById('dirPath').textContent = data.directory_path;
                    
                    // 显示错误文件（如果有）
                    if (data.error_files && data.error_files.length > 0) {
                        const errorSection = document.getElementById('durationErrorSection');
                        const errorList = document.getElementById('durationErrorList');
                        
                        errorList.innerHTML = '';
                        data.error_files.forEach(file => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-start';
                            li.innerHTML = `
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">${file.filename}</div>
                                    ${file.error}
                                </div>
                                <span class="badge bg-danger rounded-pill">!</span>
                            `;
                            errorList.appendChild(li);
                        });
                        
                        errorSection.classList.remove('d-none');
                    } else {
                        document.getElementById('durationErrorSection').classList.add('d-none');
                    }
                    
                    resultDiv.classList.remove('d-none');
                } else {
                    errorMessage.textContent = data.message;
                    errorAlert.classList.remove('d-none');
                }
            } catch (err) {
                errorMessage.textContent = `请求失败: ${err.message}`;
                errorAlert.classList.remove('d-none');
            } finally {
                calculateBtn.disabled = false;
                spinner.classList.add('d-none');
            }
        });
    </script>
</body>
</html>